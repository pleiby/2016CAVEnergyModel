---
title: "Elas VKT and Elas PKT"
author: "Paul N. Leiby"
date: "3/27/2019"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=F, message=F, warning=F}
library(tidyverse)
library(knitr)
echoWorking = F
```

```{r basicUSTripStats, echo=echoWorking}
# U.S. DOT-NHTSA 2018. Summary of Travel Trends 2017 National Household Travel Survey - 2017_nhts_summary_travel_trends. https://nhts.ornl.gov/assets/2017_nhts_summary_travel_trends.pdf
# U.S. DOT-BTS 2019. Tranportation Statistics Annual Report - Final - TSAR-Full-2018-Web-Final, Feb. 2019 https://www.bts.gov/sites/bts.dot.gov/files/docs/browse-statistical-products-and-data/transportation-statistics-annual-reports/TSAR-Full-2018-Web-Final.pdf
numHHvehiclesUS2017 = 223E6  # US DOT-NHTSA 2018 p. 68
numAveTripsPerPersonDailyUS2017 = 3.37  # US DOT-NHTSA 2018 p. 40
numAveTripsPerPersonAnnualUS2017 = 1231  # US DOT-NHTSA 2018 p. 32
numAvePersonTripsAllModesAnnualUS2017 = (64582+6048+142754+40303+102327+15139)*1E6  # US DOT-NHTSA 2018 p. 29
numAvePersonTripsPrivateVehicleAnnualUS2017 = 0.826 * numAvePersonTripsAllModesAnnualUS2017  # US DOT-NHTSA 2018 p. 30
totalRegisteredVehiclesUS2016 = 268799083 # US DOT-BTS 2018 p. 1-4
numAveVehiclesPerHHUS2017 = 1.88  # US DOT-NHTSA 2018 p. 59
```

## Relationship Between the Elasticity of VKT and Elasticity of PKT Given Ride Pooling

Vehicle Kilometers Travel (VKT) or $M_V$ is related to Passenger Kilometers Travel (PKT) or $M_P$ through vehicle occupancy *o*

$$M_V = M_P /o$$
This is essentially the defining relationship for occupancy. That is, *o* is the actual distance-weighted average occupancy of the vehicle occupancy over all segments, including e.g. ZOV kilometers from repositioning, single-passenger kilometers and high-occupancy kilometers when pooling. Thus average occupancy can be less than or greater than the reference level for an average private household vehicle, $o_r$.

The cost per passenger kilometer $C_P$ is vehicle (capital and operating) cost per kilometer $C_V$ shared over passengers plus

- time cost for each passenger along their intended route, given VoTT $C_T(o)$ [\$/hr] and average pace $\pi$ [hr/km; 
- plus additional cost of passenger detour time in pooled mode, for incremental detour distance $\delta(o)$ [unitless];
- plus equivalent cost of the disutility of sharing space $C_D(o)$ as occupancy increases.

$$C_P ~=~ C_V/o + C_T(o) \cdot \pi + C_T(o) \cdot \pi \cdot \delta(o) + C_D(o)$$
Posit for now the function $\gamma (o)$ of relative cost increase with occupancy, that includes the effect of those cost terms that are unrelated to vehicle capital and operating cost.

$$\gamma(o) ~=~ 1 + \frac {\left ( C_T(o) \cdot \pi + C_T(o) \cdot \pi \cdot \delta(o) + C_D(o) \right )}{C_V/o} $$

So, on a per-kilometer cost basis

$$ C_P ~=~ \frac {C_V} {o} \cdot \gamma (o)$$
where $\gamma (o_r) \equiv \gamma_r = o_r C_P/C_V$, the reference ratio of full passenger costs to vehicle capital/operating costs, and $\gamma' (o) \ge 0$.

As written here, the vehicle costs $C_V$ refer _only_ to capital and operating costs per vehicle kilometer and exclude all time/disutility costs for the passengers.

Q: Is the elasticity of VKT with respect to this measure of cost per vehicle kilometer useful?

Consider travel demand elasticities with respect to (generalized) travel cost

$$ElasPKT \equiv \epsilon_{M_P,C_P} \equiv \frac {d ln PKT} {d ln C_P}$$
is the elasticity of PKT w.r.t. passenger cost/mi
and 

$$ElasVKT \equiv \epsilon_{M_V,C_V} \equiv \frac {d ln VKT} {d ln C_V}$$
is the elasticity of VKT w.r.t. vehicle cost/mi.

#### What is the relationship between elasticities?

Recall that the elasticity of a function composition is the chained product of the elasticities of each function in the composition:

$$\epsilon_{f(y(x)),x} = \frac {d ln f(y(x))} {d ln x} = \frac { \frac {df}{dy}\frac {dy}{f(y)} }{dx/x}  $$


$$\begin {align}
\epsilon_{f(y(x)),x} &= \frac {df}{dy}\frac {dy}{f(y)} \frac {x}{dx} \\
&= \frac {df}{dy}\frac {dy}{f(y)} \frac {y}{y} \frac {x}{dx} \\
&= \frac {df}{dy}\frac {y}{f(y)} \frac {dy}{dx} \frac {x}{y} = \epsilon_{f,y} \epsilon_{y,x}  
\end {align}$$


Similarly, the demand for VKT is the compostion of functions of the demand for PKT which is in turn a function of the cost of vehicle travel and occupancy

$$M_V(C_V) = f(M_P(C_P(C_V, o)))$$
specifically

$$M_V(C_V) = \frac {M_P(C_P(C_V, o))}{o(\cdot)}$$

$$\epsilon_{M_V, C_V} \equiv \frac {d ln M_V} {d ln C_V} ~=~ \frac {d ln M_P} {d ln C_V} - \frac {d ln o} {d ln C_V}$$
$$\frac {d ln M_P} {d ln C_V} ~=~ \frac {d ln M_P} {d ln C_P} \cdot \frac {d ln C_P} {d ln C_V}$$

$$\epsilon_{M_P, C_V} ~=~ \epsilon_{M_P, C_P} \cdot \epsilon_{C_P, C_V}$$
Finally, looking at the elasticity of passenger travel cost with respect to vehicle travel cost:
$$C_P ~=~ \frac {C_V}{o(\cdot)} \gamma(o(\cdot))$$
Using the rules for the elasticity of function products and compositions:

$$\epsilon_{C_P, C_V} ~=~ 1 - \epsilon_{o, C_V} + \epsilon_{\gamma, o} \cdot \epsilon_{o, C_V}$$

$$\epsilon_{C_P, C_V} ~=~ 1 - \epsilon_{o, C_V} (1 - \epsilon_{\gamma, o})$$
This result has the following corner cases:
$\epsilon_{C_P, C_V} ~=~ 1$, i.e. $C_P/C_V = constant$ if

- if $\epsilon_{o, C_V} = 0$, that is if occupancy is invariant w.r.t. vehicle travel cost;
- if $\epsilon_{\gamma, o} = 1$, that is if $\gamma(o) = k o^1$ and the disutility multiplier of passenger costs rises proportionally with occupancy *o*, essentially offsetting the monetary cost reduction from spreading the vehicle costs over more passengers.

Returning to the relationship between `ElasVKT` and `ElasPKT`:
$$\begin {align}
\epsilon_{M_V,C_V} &= \epsilon_{M_P, C_V} - \epsilon_{o,C_V}\\
&= \epsilon_{M_P, C_P} \epsilon_{C_P, C_V} - \epsilon_{o,C_V}\\
\end {align}$$

$$\epsilon_{M_V,C_V} = \epsilon_{M_P, C_P} \cdot \left (1 - \epsilon_{o, C_V} \cdot (1- \epsilon_{\gamma,o}) \right ) - \epsilon_{o,C_V}$$
This relates the elasticity of VKT with respect to vehicle costs to the elasticity of PKT with respect to costs per passenger mile, with terms (elasticities) that relate to the response of occupancy $o$ to vehicle cost, and the response of proporational travel disutility cost $\gamma$ to occupancy.

Q: Is the elasticity $\epsilon_{o, C_V}$ well-defined? Or do we need to speak of some other relation like $\epsilon_{o, C_P}$, the elasticity of occupancy to passenger cost per km?

#### Numerical Evaluations

Test formulation assumes:

$$\epsilon_{M_P, C_P} = -1.0$$

$$\gamma(o) = \gamma_r \cdot (o/o_r)^{\epsilon_{\gamma,o}}$$

*o* = 0.5 : 2.0 : 0.1

$\epsilon_{\gamma,o}$ = 0 : 2 : 0.1

$$o(C_V) = ???$$

## 2. PMT and VMT for Various Levels of Pooling - Numerical Examples

```{r setDemandAndPoolingParams}
ElasPKT	= -1	            #	e_{PMT,CT}
ElasCTOccupancy	= 0.5	    #	elas_{C_T,o}
ReductCTAutomation	= 0.5	#	rho_A
ReductPaceAutomation	= 1	#	PaceReduct_A
ElasTourContractionWithPooling = 0.0 #
ElasRiderDetourWithPooling = 0.0
PacePi =1/39.98

PMTVMT0 = data.frame("o" = seq(from = 0.8, to = 1.5,by = 0.05)) #	occupancy, unitless (pass/veh, normalized)
#M = M_b/o		#	unitless (normalized VMT)
#M_B /o =1/o		#	unitless (normalized VMT)

VTCostBase = read.csv("VTCostBase.csv", comment.char = "#")
VTCostAlt = read.csv("VTCostAlt.csv", comment.char = "#")

VTCostAlt1 = VTCostAlt %>% filter(
  DemScen == "DS3",
  VehType == "LDVAvgSedan"
  ) %>%
  select(CostCat, VTCost_cpm) %>%
  spread(key = CostCat, value = VTCost_cpm)
VTCostBase1 = VTCostBase %>% filter(
  VehType == "LDVAvgSedan"
  ) %>%
  select(CostCat, VTCost_cpm) %>%
  spread(key = CostCat, value = VTCost_cpm)


PMTVMT0 = PMTVMT0 %>% mutate(
  C_Fbase = VTCostBase1$Fuel,		#	cents/mi VTCostBase(Fuel, LDVAvgSedan)
  C_F = VTCostAlt1$Fuel,		#	cents/mi VTCostAlt(Fuel, LDVAvgSedan)
  C_Hbase = VTCostBase1$Total - VTCostBase1$Fuel - VTCostBase1$Time,		#	cents/mi VTCostBase(NonFuelOrTime, LDVAvgSedan)
  C_H = VTCostAlt1$Total - VTCostAlt1$Fuel - VTCostAlt1$Time,  		#	cents/mi VTCostAlt(NonFuelOrTime, LDVAvgSedan)
  C_Tbase = VTCostBase1$Time	  
)

PMTVMT0 = PMTVMT0 %>% mutate(
  C_Vbase = C_Fbase + C_Hbase,		#	cents/mi
  C_V = C_F + C_H,		#	c/mi
  c_Vbase = C_Vbase / C_Vbase[o==1.0],		#	unitless
  c_V = C_V /C_Vbase[o==1.0] 	#	unitless
)

PMTVMT0 = PMTVMT0 %>% mutate(
  C_VPM_base = C_Vbase /o,		#	c/pass-mi
  C_VPM = C_V / o,		#	c/pass-mi
  rho_o = o^ElasCTOccupancy,		#	unitless (Pooling Time Cost Mult)
  Pi_base =1/39.98,		#	hr/mi
  Pi = Pi_base * ReductPaceAutomation		#	hr/mi
)

PMTVMT0 = PMTVMT0 %>% mutate(
  C_Tbase = rho_o *C_Tbase/Pi_base,		#	cents/hr
  C_T = C_Tbase*ReductCTAutomation,		#	cents/hr
  #"= C_Tbase*Pi_base,		#	cents/mi
  #"= C_T * Pi,		#	cents/mi
)

PMTVMT0 = PMTVMT0 %>% mutate(
  C_Mbase = C_Vbase/o + C_Tbase*Pi_base,		#	cents/mi
  C_M = C_V/o + C_T*Pi		#	cents/mi
)

PMTVMT0 = PMTVMT0 %>% mutate(
  PMT_mv = (C_Mbase/C_Mbase[o==1.0])^ElasPKT,		#	pass-mi (normalized)
  PMT_av = (C_M/C_Mbase[o==1.0])^ElasPKT,		#	pass-mi (normalized)
  VMT_mv = PMT_mv/o,		#	veh-mi (normalized)
  VMT_av = PMT_av/o,		#	veh-mi (normalized)
  VMT_mv_direct = PMT_mv[o==1.0]/o,		#	veh-mi (normalized)
  VMT_av_direct = PMT_av[o==1.0]/o		#	veh-mi (normalized)
)

```

```{r}

```

```{r}
ElasPKT	= -1	#	e_{PMT,CT}
ElasCTOccupancy	= 0.5	#	elas_{C_T,o}
ReductCTAutomation	= 0.5	#	rho_A
ReductPaceAutomation	= 1	#	PaceReduct_A
ElasTourContractionWithPooling = 0.0 #
ElasRiderDetourWithPooling = 0.0
PacePi =1/39.98

VTCostBase = read.csv("VTCostBase.csv", comment.char = "#")
VTCostAlt = read.csv("VTCostAlt.csv", comment.char = "#")

VTCostAlt1 = VTCostAlt %>% filter(
  DemScen == "DS3",
  VehType == "LDVAvgSedan"
  ) %>%
  select(CostCat, VTCost_cpm) %>%
  spread(key = CostCat, value = VTCost_cpm)
VTCostBase1 = VTCostBase %>% filter(
  VehType == "LDVAvgSedan"
  ) %>%
  select(CostCat, VTCost_cpm) %>%
  spread(key = CostCat, value = VTCost_cpm)


PMTVMT = data.frame("o" = seq(from = 0.8, to = 1.5,by = 0.05), Case0="base", Case1="alt") #	occupancy, unitless (pass/veh, normalized)
#M = M_b/o		#	unitless (normalized VMT)
#M_B /o =1/o		#	unitless (normalized VMT)


PMTVMT = PMTVMT %>% mutate(
  C_Fbase = VTCostBase1$Fuel,		#	cents/mi VTCostBase(Fuel, LDVAvgSedan)
  C_F = VTCostAlt1$Fuel,		#	cents/mi VTCostAlt(Fuel, LDVAvgSedan)
  C_Hbase = VTCostBase1$Total - VTCostBase1$Fuel - VTCostBase1$Time,		#	cents/mi VTCostBase(NonFuelOrTime, LDVAvgSedan)
  C_H = VTCostAlt1$Total - VTCostAlt1$Fuel - VTCostAlt1$Time,  		#	cents/mi VTCostAlt(NonFuelOrTime, LDVAvgSedan)
  C_Tbase = VTCostBase1$Time	  
)

PMTVMT = PMTVMT %>% mutate(
  C_Vbase = C_Fbase + C_Hbase,		#	cents/mi
  C_V = C_F + C_H,		#	c/mi
  c_Vbase = C_Vbase / C_Vbase[o==1.0],		#	unitless
  c_V = C_V /C_Vbase[o==1.0] 	#	unitless
)

PMTVMT = PMTVMT %>% mutate(
  C_VPM_base = C_Vbase /o,		#	c/pass-mi
  C_VPM = C_V / o,		#	c/pass-mi
  rho_o = o^ElasCTOccupancy,		#	unitless (Pooling Time Cost Mult)
  Pi_base =1/39.98,		#	hr/mi
  Pi = Pi_base * ReductPaceAutomation,		#	hr/mi
  TourContraction = o^ElasTourContractionWithPooling,
  RideDetourExpansion = o^ElasRiderDetourWithPooling
)

PMTVMT = PMTVMT %>% mutate(
  C_Tbase = rho_o *C_Tbase/Pi_base,		#	cents/hr
  C_T = C_Tbase*ReductCTAutomation,		#	cents/hr
  #"= C_Tbase*Pi_base,		#	cents/mi
  #"= C_T * Pi,		#	cents/mi
  C_Mbase = C_Vbase/o + C_Tbase*Pi_base,		#	cents/mi
  C_M = C_V/o + C_T*Pi		#	cents/mi
)

PMTVMT = PMTVMT %>% mutate(
  PMT_mv = (C_Mbase/C_Mbase[o==1.0])^ElasPKT,		#	pass-mi (normalized)
  PMT_av = (C_M/C_Mbase[o==1.0])^ElasPKT,		#	pass-mi (normalized)
  VMT_mv = PMT_mv/o,		#	veh-mi (normalized)
  VMT_av = PMT_av/o,		#	veh-mi (normalized)
  VMT_mv_direct = PMT_mv[o==1.0]/o,		#	veh-mi (normalized)
  VMT_av_direct = PMT_av[o==1.0]/o,		#	veh-mi (normalized)
  EnergyUse_av = VMT_av*C_F/C_Fbase
)
```

```{r}
More = PMTVMT %>% select(o, C_Vbase, C_Tbase, C_V, C_T, Pi_base, Pi)
vals = PMTVMT %>% select(o)
vals$ElasTourContractionWithPooling = seq(from = -0.3,to = 0,length.out = nrow(vals))

left_join(More, vals, by="o")

```


---
title: "CAVESIM Notes and Next Steps"
author: "Paul Leiby"
date: "02/19/2020"
output:
  html_document:
    df_print: paged
---

CAVESIM Temp Notes for Development and Next Steps
==================================

Completed 20190922 CAVdecom version
-----------------------------------

- This version: reset to Reproduce base test calculations in prior spreadsheet
    - see logical switch variantTechScen4 <- F, resets results to match test spreadsheet. Value T halves energy intensity savings in TechScen 4 for section 8 exploration of Pooling impacts

- display Printed date automatically
- use logical flag variantTechScen4 to switch off variant
- standardize numerical check reporting as "Check:"
- try using fn `janitor::adorn_totals()` for sum over rows

- _omits_ Variant input set in Section 3.2: "LDV Energy Intensity Reduction is halved for TechScen 4""
- satisfies Benchmark 0 checks on paramters and results
    - 3.2 Energy Intensity by Vehicle Type and Technology Scenario, by Composing Mechanism Effects
        - Check: Calculated Net Energy Intensity Changes match old workbook test values to within 1.287431e-09 total absolute error.
    - 4.5 Fractional VMT Changes in CAV Demand Scenario (Single Tech Case)
        - Check: Calculated test output to Kaya (VMTIncrease table) matches examples for CombScen in CS1 CS2 CS3 CS4 CS5 CS6 CS7 to within 3.783225e-08
    - 5.1 Final Scenario Results Table for 2050
        - Check: Calculated values match Scenario Results test values (intensity, VMT, EUse) to within total absolute error  6.526996e-09.
    - 8.1 Consider alternative occupancy levels, and their effects on costs, PMT, and VMT
        - Not checked yet
        
20190924 Version CAVESIMver10
------------------------------

- Partial inclusion of SMART Workflow Scens B & C, low & high
    - add 4 scenarios to DemScen, CombScen (no changes to TechScen set)
    - Clarify that CombScen is a combination of DemScen and TechScen
        - CombScen not in DemScenAdjustments
    - A DemScen is a combination of (non-energy) cost shifts, demand response factors, and exog demand shifts.
    - Refine RidePoolAdj changes to VKT from hailing/pooling
        - case-dependent effect left_joined to VMTIncrease df
        - but need to subdivide travel categories by vehicle Automation and Use (Private v. Shared)
    - Still need to make finer distinctions re VoTT changes (by Veh type and Travel category type, e.g. Hwy vs. Arterial)
    - CaseEffectsEI more clearly named TechScenEffectsEI
    - Define CombScen in CombScen_Combinations table
    - Select Combined cases CombScen from full set generated by loop over GatherScenInputsForOneTechScen()
- Limitations
    - Too many place require manual (literal) listing of Cases, e.g. initialization of VTCShrAlt
    - Need to consider multiple levels of Sharing impact on VMT

20190926 Version CAVESIMver10
------------------------------- 
- Include mix of vehicle types by Automation, Fuel, Use tpe.
    - Develop share-weighted results given F_A_Shares (for Fuel and Automation) and U_Share (for Use, i.e. Private/Shared)
    - Shares are developed from SMART FY19 Scenario COmmon Assumptions, processed by source()ing the "...DataPrep.R" script.
    - Add Test, Zero, and Base DemScens for comparison (Test should be close to old CombScen4) 
    - develop shifts (multipliers) for Automation effect onIntensity and VMT, based on Vehicle tech type: mI_A mI_C, mI_FA.
    - Also multiplier for overall efficiency (not Automation efficiency impact) mI_F
    - Delay application of VMT demand shift from Shared vehicle reposition to disaggregate impact phase.
    - New postProcessComScenarioResults chunk applies adjustments to I and VMT changes based on vehicle type
    - Share-weighted aggregation of fractional changes is tricky, see notes. 
       - Still testing
    - modified keepCaseWantedEffectsaAndAssumps chunk to aggregate back up to vehicle class VC level, to reproduce old bar charts.

20190927 Version CAVESIMver10
-------------------------------

20190929am Version CAVESIMver10
--------------------------------
- implement functions for major case df calculations, improve disaggregation and checks
    - define aggregateSelectedCaseAssumpsResults() fn  (just turns chunk into fn)
    - define aggregateSelectedCaseEffects (just turns chunk into fn)
    - pass set of DemScen(s) to be analyzed to CombScenInputsAndResultsForOneTechScen()
    - Ex post modification seek to test/adjust I_deltaCAV in CombScenInputsAndResultsForOneTechScen() to reflect disaggregated NIE for subsegment
    - elim unused `DemRespParamsm`
    - add new test comparing NIE to I_deltaCAV
    - add new display of tests on sum of disaggregated shares
    - ToDo: need to use adjusted NIE earlier in CombScen calculation function

ToDo Next 20190927
--------------------
- [x] 1. Establish technology and demand scenario assump starting points in CAVdecom code
    - Eliminate refs to spreadsheet tests, reading and melding of spreadsheet params
- [x] 2. Save as CAVESIMver10.Rmd
- [x] 3. Establish new set of scenarios: Base, B-Low, B-High, C-low, C-high
- [x] 4. Include Automation_accessory_Load Energy use 
    - (convert kW to fraction of base vehicle average energy use (V [MPH] / E [MPG]) * kWh/Gal * EngineEffiency= kWh/h 
    - or get estimate of ave power use by vehicle
- [x] 5a. Update VoTT to conform to the scenarios overall (but not in detail)
6. Update vehicle categories and stock-related data to conform to the analysis
    - K_CSFAO
        - [X] C "VehClass/VC": LDV vs MDHDV
        - [ ] S "VehSubclass": {Car vs LtTruck}, {Class8 vs Other} - Aggregated these in our analysis so far
            - Car {CAR_COMPACT, CAR_MIDSIZE, CAR_FULL}
            - LtTruck {SUV_COMPACT, SUV_MIDSIZE, SUV_FULL_SIZE, TRUCK_MIDSIZE, TRUCK_FULL}
        - [x] F "Fuel_Tech" (Fuel/Drivetrain technology)
            - [x] Summary categories:
                - Conventional {Conventional, Conv-48V}
                - HEV
                - PHEV
                - BEV
        - [ ] Elect veh vs "conventional" drivetrain efficiency adjustment
        - [x] Automation
            - No (Manual)
            - Partial
            - Full
        - [x] O Ownership/Operation (at this point, only affects extend of Empty VMT)
            - Private
            - Shared
    - [ ] Automation's shares by "Fuel_Tech" (Drive)
        - [x] No vs. Partial vs. Full AV shares
    - [ ] shares/quantities of vehicles by class: 
        - LDV (Cars, LtTrucks) and HDV Stock, determineed by AEO Base aggregate energy demand
- [ ] Update reference ride sharing in each scenario
    - use total shares from POLARIS
- [x] Update Base impact of automation/sharing on VMT (repositioning empty ZOV miles)
    - see comparison with POLARIS
- Results
    - [x] Produce Bar charts of AV cost components and shares
    - [x] Produce Bar charts of energy intensity, VMT and energy
    - [ ] Produce Graphs of energy, VMT, PMT vs occupancy, for 
    - [ ] Produce Graphs of energy use vs cost (by mile and gallon)
    - [ ] Plot of VMT, PMT vs incentive, accounting for fraction of travel that is shared (and potentially pooled)
        - account for overall demand reduction with VMT (from efficient tax computation)
        - exclude shift toward pooled with universal VMT charge
        - exclude shift away from pooled with shared veh-only VMT charge

20191002 Version CAVESIMver10
--------------------------------
- modify Sec. 6.3 Est Scenario effects:
    - Scenario with economic response to occupance and road charge
    - For shared mobility, differentiate between
        - PMT cost VMT cost
        - PMT demand and VMT demand
- make assumptions re Pooling impact on VMT through params in chunk setDemandAndPoolingParams
    - elas_VoTT_wrt_Pooling
    - Elas_TourLength_wrt_Pooling
    - Elas_RiderDetour_wrt_Pooling
    - PacePi
    - ReductPaceAutomation
- make Adjustments to VMT Demand (not necessarily PMT demand) based on scenario vehicle Use (Shared vs. Private)
    - for Use == "Shared", adjust mD_U = (1 + RidePoolAdjFrac)
- Added Dem/Tech scen cost charts for selects SMART scenarios (Base, B_Low/B_High, C_Low/C_High)
  - Note: have to choose TechScen cases to match with these DemScen cases
- Modify output for Capstone contribution
  - fine-tune graph titles, resolution

Next Steps for Benchmarking and Refining
-----------------------------------------
- Include vehicle type shifts in TechScen
    - Automation fractions
    - Electrification fractions
- Include other factors in DemScen
    - Use/Ownership (shared vs. private) fractions
- Seek to benchmark average speed for local and intercity driving, for both LDVs and HDVs.
- Better-represent ways CAVs could alter average speed, and therefor travel time cost per mile.
- Add energy demand from automation load
    - can this fit in fractional change approach, given usually specified as fixed load?
    - see bounds report for reference
- Alter cost-elastic response to account for pooling. 
    Currently, the `VMTIncrease` table of `fracVMTincr` calculations applies the _VKT_ elasticity, estimated and appropriate for cost response at the reference level (near zero) pooling.

- Benchmark 
    - ReductCTAutomation    = 0.5   #   rho_A, reduction factor for the Cost of Travel Time (per hour) (now scenario dependent)
    - elas_VoTT_wrt_o <- 0.5 #    elas_{C_T,o}, elasticity of Cost of Travel time C_T = VoTT, w.r.t. occupancy,
        - an assumption regarding how higher occupancy (pooling) increases time cost VoTT
    - Elas_TourLength_wrt_Pooling <- 0.0 # elasticity of Vehicle tour length (for mult pooled trips) w.r.t. occupancy
    - Elas_RiderDetour_wrt_Pooling <- 0.0 # elasticity of Passenger trip length w.r.t. occupancy and pooling
    - PacePi <- 1 / 39.98 # base or default pace, hr/mi
    - ReductPaceAutomation <- 1 #     PaceReduct_A, reduction factor for the pace (hr/km) (or increase in average speed), i.e. the quantity of travel time per trip, from automation
- Review Data assumptions obtainble from Capstone report
- Review Data assumptions obtainable from Bounding Update drafts

ToDos for Refining
-------------------
- Next steps for functions CombScenResultsForOneTechScen() and GatherScenInputsForOneTechScen()
    - use _local_ vars to make iteratively make calculations of many dataframes
        - nie
        - DemRespParams (need DemRespParamsBase)
        - VTCShrAlt (needs VTCShrBase)
        - RelTotCost (needs VTCShrAlt)
        - VMTIncrease (needs) RelTotCost)
        - VMTIncrease
    - collapse the two long, largely duplicative, functions into 1, or have the second call the first

- Section 8: need to extract VTCostAlt from full set of CaseAssumptions, selecting out DemScen, TechScen, ElasCase of interest.

Planned Steps for Revised Contribution to Capstone Report 20191127
---------------------
#### worthwhile points/approaches from bounds works
- 

#### Factors to Highlight
- effect of costs of CAV on VKT and Energy use
- effect of vehicle efficiency
- effect of delays/detours and willingness-to-pool on VMT
  - need mix between pooled vs hailed within Shared ridership fraction
- make Scenario effects randomized (disribution)
- show effect of incentives (road use charge, sharing incentives)

ToDo Next 20191127
--------------------
- [ ] 4. Revisit Automation_accessory_Load Energy use 
    - (convert kW to fraction of base vehicle average energy use (V [MPH] / E [MPG]) * kWh/Gal * EngineEffiency= kWh/h 
    - or get estimate of ave power use by vehicle
- [ ] 5b. More careful Update VoTT cases to conform to the scenarios detail (`C_deltaVoTT` should be dependent on Automation and Use (Sharing/Pooling))
- [ ] 5c. More careful Update VoTT cases to conform to the scenarios detail ??? duplicate
- [ ] 5d. Refine speed calculations, distinguishing between Highway and Arterial reference speed (this influences trip time and VoTT calculation per mile) 
- [ ] 5e. Refine speed calculations, better-accounting for effect of autmation on (average) traffic speed (see ReductPaceAutomation) (this influences trip time and VoTT calculation per mile) 
- [ ] 6. Refine vehicle categories and stock-related data to conform to the analysis
    - K_CSFAO
        - [X] C "VehClass/VC": LDV vs MDHDV
        - [ ] S "VehSubclass": {Car vs LtTruck}, {Class8 vs Other} - Aggregated these in our analysis so far
            - Car {CAR_COMPACT, CAR_MIDSIZE, CAR_FULL}
            - LtTruck {SUV_COMPACT, SUV_MIDSIZE, SUV_FULL_SIZE, TRUCK_MIDSIZE, TRUCK_FULL}
        - [x] F "Fuel_Tech" (Fuel/Drivetrain technology)
            - [x] Summary categories:
                - Conventional {Conventional, Conv-48V}
                - HEV
                - PHEV
                - BEV
        - [ ] Elect veh vs "conventional" drivetrain efficiency adjustment
        - [x] Automation
            - No (Manual)
            - Partial
            - Full
        - [x] O Ownership/Operation (at this point, only affects extend of Empty VMT)
            - Private
            - Shared
    - [ ] Automation's shares by "Fuel_Tech" (Drive)
        - [x] No vs. Partial vs. Full AV shares
    - [ ] shares/quantities of vehicles by class: 
        - LDV (Cars, LtTrucks) and HDV Stock, determineed by AEO Base aggregate energy demand
- [ ] 7. Check/Update reference ride sharing in each scenario
    - use total shares from POLARIS
- [ ] 8. Update Base impact of automation/sharing on VMT (repositioning empty ZOV miles)
    - see comparison with POLARIS
- Results
    - [x] Produce Bar charts of AV cost components and shares
    - [x] Produce Bar charts of energy intensity, VMT and energy
    - [ ] Produce Graphs of energy, VMT, PMT vs occupancy, for 
    - [ ] Produce Graphs of energy use vs cost (by mile and gallon)
    - [ ] Plot of VMT, PMT vs incentive, accounting for fraction of travel that is shared (and potentially pooled)
        - account for overall demand reduction with VMT (from efficient tax computation)
        - exclude shift toward pooled with universal VMT charge
        - exclude shift away from pooled with shared veh-only VMT charge
- [ ] Code clarification and streamlining
    - streamline functions: updateI_deltaCAVinDemRespParams

Summary of CAVESIM Model Steps (as of 20200216)
-------------------------------------------
1. Establish set of Technology Mechanisms `IEffectsm$Mech`
    - a. that can alter vehicle energy intensity
    - b. that can shift/alter VMT demand
1. Establish range of impacts $\mu_{tvks}$ or `IEffectsm$IM`, for each of those Mechanisms for 4 "EffectCase" (Zero, Pess, Mid, Opt) 
    - plot range by mechanism in bar graph
1. Define `TechScen` technology scenarios that establish fractional changes in vehicle energy intensity for each Mechanism $s_{tjvk}$, which associates an `EffectCase` *s* for each `Mech` *k* and `TechScen` *j*.
    - the $s_{tjvk}$ are indicated in `msa$EffectCase`
1. Calculate Net Energy Intensity change for each TechScen as the product of the individual mechanism multipliers minus 1.0
    - $\Delta I_{jtv}$ = `EnergyIntensityChanges$NIE`
    - also $\Delta I_{jtv}$ = `EnergyIntensityCompons$NIE`, which also includes the multipliers for each of the (9) intensity mechanisms `Mech`
1. Plots (Sec 3.3):
    - Plots of (net) Energy Intensity Changes by Technology Scenario (Year and VC)
    - Plot of Energy Intensity Effect ranges by Mechanism
1. (Sec. 3.4) Establish Cases for Exogenous Demand Effects 
    - `DEffectsTemp` specifies demand mechanism values in 4 EffectCase for 
        - `D_Underserved_travelers`, `D_Ride_Hailing_Empty_Miles`, `D_Induced_VMT_Demand`
    - combine this with `IEffects` to `CombIDEffects` and plot bar chart of mechanism effect ranges
1. (Sec 4) Develop Demand Response to CAVs: exegenous demand shifts and an endogenous travel demand response to net change in generalized travel cost
1. (Sec 4.1.1) Establish Demand Response Parameters in df `DemRespParams`
    - in `DemRespParams` for `VC`, `Parameter`, and 4 `EffectCase`s.
        - `ElasVKT`, `ExclVehCapCost`, `C_xxx`, for xxx in {deltaMaint, deltaInsurX, deltaCapCost, deltaTolls, deltaParking, deltaRegis, deltaVoTTHwy, deltaVoTTArt}
    - in `DemScenCostChange` for `DemScen`, `C_deltaVoTT`, `C_deltaInsur`
        - `DemScen` set include numbered DSn and selected SMART Scenarios, and "Zero"
1. (Sec 4.1.2) Establish the (exog) Reference Mix of Vehicle Types in the Desired Demand Scenarios
    - yields `shares_by_F_A` F_A_Shares by VC, Automation, Fuel, DemScen.
    - yields `shares_by_U` U_Shares by VC, Use, DemScen.
1. (Sec 4.1.3) Select a Single Technology Scenario and Year to Examine
    - define `updateI_deltaCAVinDemRespParams()` to Update `I_deltaCAV`, net energy intensity change, in `DemRespParams`, to be consistent with current TechScen
    - define `nieForScenYear()` to extract net energy intensity change in `DemRespParams` by Veh Class for TechScen and Year
1. (Sec 4.2) Establish Base vehicle travel costs, and cost shares, by component
    - establish df `VTCostBase`, which has `VTCost_cpm` by `VehType` and `CostCat`
    - travel time costs per mile `TTC_per_mi`, based on ave `speed` and `VoTT`, calculated and copied to `VTCost_cpm` for `CostCat` == `Time`)
    - base cost shares in `VTCShrBase`
1. (Sec 4.3) Cost Changes and Fractional Increase in VKT for Demand/Technology Scenarios
    - Calculate fractional change in demand, for Demand Scenario *d*, Year *t*, and VehicleClass *v*, based on changes in time cost, other vehicle fuel and operating costs, and VMT demand elasticity w.r.t generalized cost.
    - calc `VTCShrAlt` and `VTCostAlt`:
    - (Sec 4.4) Calculate Adjusted Travel Cost Components for Demand Scenario Conditions
        - Updated cost component table VTCShrAlt based on *Demand* Scenario adjustments to VoTT (`C_deltaVoTT`) and other costs.
        - Calculate cost component as relative fractions (pseudo-shares) for all demand scenarios.
    - calc `RelTotCost` as total cost ("Total") by "DemScen", "VehType", "VC", "Case"
1. Plot, for a set of DemScen/TechScen combos
    - relative total costs (shares) and relative component shares (with `plotStackedBarShares()` fn)
    - costs (cents/mi) and component costs (with `plotStackedBarCostCompons()` fn)
1. (Sec 4.5) Calc Fractional VMT Changes in CAV Demand Scenario (Single Tech Case)
    - append, `RelTotCost` associated variables `ElasVKT` and compute `fracVMTIncr`, the cost-elastic response
    - then apply (multiplicative) exog demand shifts
        - Effects on VMT Demand from Underserved Population, and Ride Hailing & Pooling
            - from table/df `UnderservedVMTmult` (`USDmult` for each `USOption`)
            - from table/df `refRideHailingPoolingAdj` (adj fractional change by vehicle `Use`, `Automation`, and `EffectCase` (Zero ... High))
        - values of each exog demand effect determined in table `DemScenAdjustments`
            - which specifies selected `USOption` and `RidePoolAdj` (`EffectCase`) to apply by `VC`, and `DemScen`
    - suitable numerical multipliers/shifts are compiled in table `DemScenAdjustments`
        - gives `USDmult` and `RidePoolAdjFrac` (shift) values by "VC", "DemScen", "USOption", and "RidePoolAdj"
    - these exog effects are applied to `fracVMTIncr` in df `VMTIncrease`

1. (Sec 5) Execute Policy and Combined Scenario Calculations
1. Create a dataframe of changes in Energy Intensity and Travel Demand, for all Combined Scenarios.
    - Note: Demand calculation applies the VKT elasticity indicating cost response at the reference level (near zero) pooling
1. Given a set *D* of demand scenarios (`DetailedDemScens`) Loop over all Tech Scenarios (TechScen) and develop a table of all combinations of Tech Scenarios and Demand Scenarios
    - apply fn `CombScenInputsAndResultsForOneTechScen`(CurrTechScen, CurrYear, DetailedDemScens))
    - produced df `CaseAssumpsResults_many`
1. Construct details of scenario, disaggregated by vehicle class, automation, fuel technology, use type.
    - DemScenAdjustments is `RidePoolAdjFrac` and `USDmult` for each `VC` and `DemScen` (which determine case categorical vars `USDOption` and `RidePoolAdj`)
1. Establish `DisaggParams` 
    - for a target subset of `DemScen` in `DetailedDemScens` (e.g. Base, B_High and C_High), and for each vehicle class `VC`
    - specifies disaggregated demand and intensity adjustment factors for `VC` and `DemScen` by Vehicle Fuel, Automation and Use (F, A and U) categories.
1. Create `CaseAssumpsResults` from `CaseAssumptionsResults_Many` for selected `DemScen` in `DetailedDemScens`
1. Add vehicle shares by F&A, and by U, to each combination of `VC` and `DemScen` in `CaseAssumpsResults`
    - Expand table to disaggregate by Vehicle category: Fuel Type, Automation, Use
    - (replicates rows card(A) x card(F) x card(U) times and appends shares



CAVESim ToDo Next 20200220
---------------------------
- [ ] ToDo: distinguish between local and intercity speed and time cost (VoTT, `VTCost_cpm$Time`) per mile in scenarios.
- [ ] In Sec 5.1 (fn `CombScenInputsAndResultsForOneTechScen()`)
    - [ ] ToDo: generalize `DemRespParams$C_deltaXxx` to include potential shifts on _all_ travel cost components, and vary by Veh technology
    - [ ] ToDo: apply vehicle-technology specific `I_deltaCAV` to costs prior to application of `ElasVKT`. I.e., `I_deltaCAV` to vary with level of Automation and Electrification (Fuel).
- [ ] ToDo: Needed data: Seek to benchmark average speed for local and intercity driving, for both LDVs and HDVs. These regional values should be consistent with overall average speed.
- [ ] ToDo: Better-represent ways CAVs could alter average speed, and therefor travel time cost per mile.
- [ ] ToDo: Note: total relative travel cost per mile and its fuel and non-fuel components will vary with
Automation *A* and Fuel/Drivetrain type *F*. Previous cost components were for Full Automation,
and each associated Technology and Demand scenario.
- [ ] ToDo: Increase flexibility in accomodating different fractions of automated, electrified and shared mobility in the scenario. (currently these are exogenous and fixed, and not all cost/intensity/VMT effects are accounted)
- [ ] In sec 6 calculation of `OccupancyEffects`:
    - [ ] ToDo: Need Sharing disutility here
    - [ ] ToDo: Account for deadheading/respositioning miles in ref (No Pooling) case
- [ ] ToDo: make enumeration of elements in SetJ_TechScen (Scenarios j) and SetD_DemScen a result of read tables, rather than explicit
    - originally, `C_Time` at this point differentiated only by `VC` and `DemScen`
- [ ] ToDo: get ShrECostInt to do recalc of `fracVMTIncr` in disaggregation of `CaseAssumpsResults` by veh subcat
    